<!doctype html>
<html>

<head>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
	<script src="./dist/binary.js"></script>
</head>

<body>
	<div id="progress" align="center">0% complete</div>
	<div id="box" style="background: #eee; font-size: 26px; width: 400px; height: 300px;line-height: 300px; margin: 0 auto; text-align: center;">
		Connecting...
	</div>

	<script>

	// var client = new BinaryClient('ws://localhost:9000',{
	// 	chunkSize: 1*1024*1024,
	// 	simultaneous: 4,
	// 	prefix: 'mcs_'
	// });

	var uploadSocket = 'ws://localhost:9000';
	var uploadConfig = {
		chunkSize: 1*1024*1024,
		simultaneous: 2,
		suffix: '_mcs_'
	};
	var box = $('#box');
	var tx = {};
	box.on('dragenter', doNothing);
	box.on('dragover', doNothing);
	box.text('Drag files here');
	box.on('drop', function(e) {
		e.originalEvent.preventDefault();
		var file = e.originalEvent.dataTransfer.files[0];

		for (var i = 0; i < uploadConfig.simultaneous; i++){
			(function(index, fileinput){
				var client = new BinaryClient(uploadSocket, uploadConfig);
				client.on('open', function() {
					var stream = client.send(fileinput, {
						index: index,
						name: fileinput.name,
						size: fileinput.size
					});

					tx[index] = 0;
					stream.on('data', function(data) {
						tx[index] += data.rx * 100;
						// console.log("Progess of stream ",index," : ", tx);
						// $('#progress').text(Math.round(tx += data.rx * 100) + '% complete ['+i+']');
					});
					stream.on('end',function(){
						console.log("File ", index," send end");
					});
					stream.on('close',function(){
						console.log("File ", index," send close");
					});
				});
			})(i, file);
		}

	});
	// Deal with DOM quirks
	function doNothing(e) {
		// console.log(e.type);
		e.preventDefault();
		e.stopPropagation();
	}
	// Wait for connection to BinaryJS server
	/*client.on('open', function() {
		var box = $('#box');
		box.on('dragenter', doNothing);
		box.on('dragover', doNothing);
		box.text('Drag files here');
		box.on('drop', function(e) {
			e.originalEvent.preventDefault();
			var file = e.originalEvent.dataTransfer.files[0];

			// Add to list of uploaded files
			$('<div align="center"></div>').append($('<a></a>').text(file.name).prop('href', '/' + file.name)).appendTo('body');

			// `client.send` is a helper function that creates a stream with the
			// given metadata, and then chunks up and streams the data.
			var streams = client.send(file, {
				name: file.name,
				size: file.size
			});

			// Print progress
			tx = [];
			for(var i in streams){
				var stream = streams[i];
				(function(i, stream){
					var index = i;
					tx[index] = 0;
					stream.on('data', function(data) {
						tx[index] += data.rx * 100;
						// console.log("Progess of stream ",index," : ", tx);
						// $('#progress').text(Math.round(tx += data.rx * 100) + '% complete ['+i+']');
					});
				})(i, stream);
			}
		});
	});*/

	</script>
</body>

</html>
